name: OPA Bundle - Build & Upload

on:
  push:
    branches: [main]
    paths:
      - 'opa/policy/**'
  workflow_dispatch:

env:
  STORAGE_ACCOUNT: ${{ secrets.STORAGE_ACCOUNT }}
  BLOB_CONTAINER: opa-bundles

jobs:
  build-and-upload:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Install OPA CLI
        run: |
          curl -L -o opa https://openpolicyagent.org/downloads/latest/opa_linux_amd64_static
          chmod +x opa
          sudo mv opa /usr/local/bin/opa
          opa version

      - name: Build OPA bundle
        run: |
          opa build -b opa/policy/ -o bundle.tar.gz
          echo "Bundle built successfully"
          tar tzf bundle.tar.gz

      - name: Login to Azure
        uses: azure/login@v2
        with:
          creds: ${{ secrets.AZURE_CREDENTIALS }}

      - name: Upload bundle to Blob Storage
        run: |
          az storage blob upload \
            --account-name "${{ env.STORAGE_ACCOUNT }}" \
            --container-name "${{ env.BLOB_CONTAINER }}" \
            --file bundle.tar.gz \
            --name bundle.tar.gz \
            --overwrite \
            --auth-mode login

          echo "Bundle uploaded to: https://${{ env.STORAGE_ACCOUNT }}.blob.core.windows.net/${{ env.BLOB_CONTAINER }}/bundle.tar.gz"
