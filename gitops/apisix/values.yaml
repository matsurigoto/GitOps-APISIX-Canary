# =============================================================================
# APISIX Helm Values — Traditional Mode (Admin API + Ingress Controller)
# =============================================================================

# ── Gateway (Data Plane) ──────────────────────────────────────────────────
gateway:
  type: LoadBalancer
  http:
    enabled: true
    containerPort: 9080
    servicePort: 80
  tls:
    enabled: false

# ── Admin API ─────────────────────────────────────────────────────────────
admin:
  enabled: true
  type: ClusterIP
  port: 9180
  credentials:
    admin: "gitops-canary-admin-key-2026"
    viewer: "gitops-canary-viewer-key-2026"
  allow:
    ipList:
      - 0.0.0.0/0

# ── APISIX Configuration ────────────────────────────────────────────────
apisix:
  enableIPv6: false

  # Enable plugins
  plugins:
    - api-breaker
    - authz-keycloak
    - basic-auth
    - batch-requests
    - consumer-restriction
    - cors
    - echo
    - fault-injection
    - grpc-transcode
    - hmac-auth
    - http-logger
    - ip-restriction
    - jwt-auth
    - key-auth
    - limit-conn
    - limit-count
    - limit-req
    - node-status
    - opa                     # ← OPA policy engine
    - opentelemetry           # ← Distributed tracing
    - prometheus              # ← Metrics export
    - proxy-cache
    - proxy-mirror
    - proxy-rewrite
    - redirect
    - referer-restriction
    - request-id
    - request-validation
    - response-rewrite
    - serverless-post-function
    - serverless-pre-function
    - sls-logger
    - syslog
    - tcp-logger
    - traffic-split           # ← Canary / Blue-Green traffic splitting
    - udp-logger
    - uri-blocker
    - wolf-rbac
    - zipkin
    - real-ip

  pluginAttrs:
    prometheus:
      export_uri: /apisix/prometheus/metrics
      enable_export_server: true
      export_addr:
        ip: "0.0.0.0"
        port: 9091
      metric_prefix: apisix_
      prefer_name: true

    opentelemetry:
      resource:
        service.name: APISIX
      collector:
        address: otel-collector.observability:4318
        request_timeout: 3
      batch_span_processor:
        max_queue_size: 1024
        batch_timeout: 2
        inactive_timeout: 1
        max_export_batch_size: 16

# ── Prometheus Metrics Port ──────────────────────────────────────────────
metrics:
  serviceMonitor:
    enabled: true
    namespace: observability

# ── Ingress Controller ───────────────────────────────────────────────────
ingress-controller:
  enabled: true
  config:
    apisix:
      adminAPIVersion: v3
      serviceNamespace: ingress-apisix

# ── etcd ──────────────────────────────────────────────────────────────────
etcd:
  enabled: true
  replicaCount: 1
  persistence:
    enabled: true
    size: 5Gi

  # Fix: bitnami/etcd images removed from Docker Hub → use bitnamilegacy
  # Fix: etcd data was written at cluster-version 3.6 → must use 3.6.x
  image:
    registry: docker.io
    repository: bitnamilegacy/etcd
    tag: 3.6.4-debian-12-r4

  # Fix: K8s 1.33 forbids multiple probe handler types.
  # The bundled Bitnami etcd chart generates both exec + httpGet → override
  # with custom single-handler probes.
  livenessProbe:
    enabled: false
  readinessProbe:
    enabled: false
  startupProbe:
    enabled: false
  customLivenessProbe:
    httpGet:
      path: /health?serializable=true
      port: 2379
    initialDelaySeconds: 60
    periodSeconds: 30
    timeoutSeconds: 5
    failureThreshold: 5
    successThreshold: 1
  customReadinessProbe:
    httpGet:
      path: /health?serializable=true
      port: 2379
    initialDelaySeconds: 15
    periodSeconds: 10
    timeoutSeconds: 5
    failureThreshold: 5
    successThreshold: 1
  customStartupProbe:
    httpGet:
      path: /health?serializable=true
      port: 2379
    initialDelaySeconds: 10
    periodSeconds: 5
    timeoutSeconds: 5
    failureThreshold: 30
    successThreshold: 1

# ── Dashboard (optional, disable for production) ─────────────────────────
dashboard:
  enabled: false
